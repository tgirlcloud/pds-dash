---
import Base from "@layouts/Base.astro";
import { createAccount } from "@lib/account";

export const prerender = false;

const ret = { err: "", success: "" };

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const handle = data.get("handle") as string;
    const email = data.get("email") as string;
    const password = data.get("password") as string;

    const result = await createAccount({ handle, email, password });
    ret.success = result.success ?? "";
    ret.err = result.error ?? "";
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
      ret.err = error.message;
    }
  }
}
---

<Base>
  <main class="main">
    <div class="hero card">
      <h1 class="hero-title">sign up</h1>
      <p class="hero-subtitle">
        Sign up for a tgirl.cloud personal data server (PDS) account.
      </p>

      <div class="hero-warning">
        Looking to migrate from another PDS? Check out our
        <a href="https://tgirl.cloud/blog/migrating-pds/">migration guide</a> instead.
      </div>

      {ret.err && <div class="hero-error">{ret.err}</div>}
      {ret.success && <div class="hero-success">{ret.success}</div>}

      <form class="hero-actions" method="POST">
        <input class="input" placeholder="handle (e.g. alice.tgirl.beauty)" name="handle" required />
        <input class="input" type="email" name="email" placeholder="email" required />
        <input class="input" type="password" name="password" placeholder="password" required minlength="8" />
        <button class="btn primary" type="submit">Create Account</button>
      </form>
    </div>
  </main>
</Base>
